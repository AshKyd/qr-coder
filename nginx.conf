user nginx;
worker_processes auto;
pcre_jit on;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    
    # We default to text/plain to avoid forcing a download if Nginx can't figure it out
    default_type text/plain;

    server_tokens off;
    sendfile on;
    tcp_nopush on;
    
    # Pre-map the .br extension back to original mime types using Nginx's map directive
    map $request_uri $brotli_content_type {
        default              application/octet-stream;
        ~*\.html(\.br)?(/)?$ text/html;
        ~*\.css(\.br)?$      text/css;
        ~*\.js(\.br)?$       application/javascript;
        ~*\.svg(\.br)?$      image/svg+xml;
        ~*\.json(\.br)?$     application/json;
        ~*\.xml(\.br)?$      application/xml;
        ~*(/)$               text/html;
    }

    server {
        listen 80;
        listen [::]:80;
        server_name _;

        root /usr/share/nginx/html;

        # Set default headers for all routes
        add_header Content-Encoding br;
        add_header Vary ""; 

        # We set the content type using the map above for everything
        add_header Content-Type $brotli_content_type;
        
        # Turn off automatic nginx mime-type setting so it doesn't duplicate our Content-Type header
        types { }
        default_type "";

        # Handle static assets exactly
        location ~* \.(js|css|svg)\.br$ {
            expires 1y;
            # Need to re-declare these because add_header inside a block overrides the parent HTTP block
            add_header Content-Encoding br;
            add_header Vary "";
            add_header Content-Type $brotli_content_type;
            add_header Cache-Control "public, max-age=315360000, immutable";
        }

        # Rewrite standard assets to their .br counterparts internally
        location ~* \.(js|css|svg)$ {
            rewrite ^(.*)$ $1.br last;
        }

        # Handle SPA HTML routing
        location / {
            # For SPA: check the exact file.br, index.br, or root index.br
            try_files $uri.br $uri/index.html.br /index.html.br =404;
        }
    }
}
